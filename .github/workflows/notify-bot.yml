name: Notify Telegram Bot on Form Response

on:
  push:
    paths:
      - 'responses.json'

jobs:
  notify:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        
      - name: Parse new responses
        id: parse
        run: |
          echo "ğŸ” Parsing responses.json..."
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ñ„Ğ°Ğ¹Ğ» ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ¸ Ğ½Ğµ Ğ¿ÑƒÑÑ‚Ğ¾Ğ¹
          if [ ! -f "responses.json" ] || [ ! -s "responses.json" ]; then
            echo "âŒ responses.json not found or empty"
            exit 1
          fi
          
          # ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ Ñ„Ğ°Ğ¹Ğ»Ğ° Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ»Ğ°Ğ´ĞºĞ¸
          echo "ğŸ“„ Current responses.json content:"
          cat responses.json
          
          # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ user_id Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ĞµĞ³Ğ¾ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°
          NEW_USER_ID=$(jq -r '.[-1].user_id' responses.json)
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ user_id Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾
          if [ "$NEW_USER_ID" = "null" ] || [ -z "$NEW_USER_ID" ]; then
            echo "âŒ Could not extract user_id from responses.json"
            echo "ğŸ“‹ Available data:"
            jq '.' responses.json
            exit 1
          fi
          
          echo "user_id=${NEW_USER_ID}" >> $GITHUB_ENV
          echo "âœ… Found new response from user: $NEW_USER_ID"
        
      - name: Send thank you message to user
        run: |
          echo "ğŸ“¤ Sending thank you message to user ${user_id}..."
          echo "ğŸ”§ Bot token length: ${#TELEGRAM_BOT_TOKEN}"
          
          RESPONSE=$(curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{
              \"chat_id\": \"${user_id}\", 
              \"text\": \"âœ… Ğ¡Ğ¿Ğ°ÑĞ¸Ğ±Ğ¾, Ñ‡Ñ‚Ğ¾ Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ¸ Ğ°Ğ½ĞºĞµÑ‚Ñƒ! Ğ’Ğ°Ñˆ Ğ¾Ñ‚Ğ²ĞµÑ‚ Ğ±Ñ‹Ğ» Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½.\"
            }")
          
          echo "ğŸ“¡ User notification response: $RESPONSE"
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ÑÑ‚ÑŒ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸
          if echo "$RESPONSE" | jq -e '.ok == true' > /dev/null; then
            echo "âœ… User notification sent successfully!"
            echo "user_notified=true" >> $GITHUB_ENV
          else
            echo "âŒ Failed to send user notification"
            echo "user_notified=false" >> $GITHUB_ENV
          fi
          
      - name: Send admin notification
        run: |
          echo "ğŸ“¤ Sending admin notification..."
          echo "ğŸ”§ Admin ID: ${{ secrets.BOT_ADMIN_ID }}"
          echo "ğŸ”§ Bot token length: ${#TELEGRAM_BOT_TOKEN}"
          
          ADMIN_RESPONSE=$(curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{
              \"chat_id\": \"${{ secrets.BOT_ADMIN_ID }}\", 
              \"text\": \"/form_completed ${user_id}\"
            }")
          
          echo "ğŸ“¡ Admin notification response: $ADMIN_RESPONSE"
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ÑÑ‚ÑŒ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ñƒ
          if echo "$ADMIN_RESPONSE" | jq -e '.ok == true' > /dev/null; then
            echo "âœ… Admin notification sent successfully!"
            echo "admin_notified=true" >> $GITHUB_ENV
          else
            echo "âŒ Failed to send admin notification"
            echo "admin_notified=false" >> $GITHUB_ENV
            echo "ğŸ” Error details: $ADMIN_RESPONSE"
          fi
          
      - name: Update database via bot command
        if: env.user_notified == 'true' && env.admin_notified == 'true'
        run: |
          echo "ğŸ’¾ Triggering database update via bot..."
          echo "ğŸ“¤ Sending database update command..."
          
          DB_UPDATE_RESPONSE=$(curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{
              \"chat_id\": \"${{ secrets.BOT_ADMIN_ID }}\", 
              \"text\": \"ğŸ“‹ Database update: User ${user_id} completed form\"
            }")
          
          echo "ğŸ“¡ Database update response: $DB_UPDATE_RESPONSE"
          
      - name: Final status report
        run: |
          echo "ğŸ¯ Final Status Report:"
          echo "ğŸ‘¤ User ID: ${user_id}"
          echo "ğŸ“¤ User notified: ${user_notified:-false}"
          echo "ğŸ‘¨â€ğŸ’¼ Admin notified: ${admin_notified:-false}"
          
          if [ "${user_notified:-false}" = "true" ] && [ "${admin_notified:-false}" = "true" ]; then
            echo "ğŸ‰ All notifications sent successfully!"
          else
            echo "âš ï¸ Some notifications failed"
            exit 1
          fi 
