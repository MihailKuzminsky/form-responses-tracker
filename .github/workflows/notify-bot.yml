name: Notify Telegram Bot on Form Response

on:
  push:
    paths:
      - 'responses.json'

jobs:
  notify:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Parse new responses
        id: parse
        run: |
          echo "ğŸ” Parsing responses.json..."
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ñ„Ğ°Ğ¹Ğ» ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ¸ Ğ½Ğµ Ğ¿ÑƒÑÑ‚Ğ¾Ğ¹
          if [ ! -f "responses.json" ] || [ ! -s "responses.json" ]; then
            echo "âŒ responses.json not found or empty"
            exit 1
          fi
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ğ¾ÑÑ‚ÑŒ JSON
          if ! python3 -c "import json; json.load(open('responses.json'))" 2>/dev/null; then
            echo "âŒ responses.json is not valid JSON"
            exit 1
          fi
          
          # ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ Ñ„Ğ°Ğ¹Ğ»Ğ° Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ»Ğ°Ğ´ĞºĞ¸
          echo "ğŸ“„ Current responses.json content:"
          cat responses.json
          
          # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ user_id Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ĞµĞ³Ğ¾ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°
          NEW_USER_ID=$(jq -r '.[-1].user_id' responses.json 2>/dev/null)
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ user_id Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾
          if [ "$NEW_USER_ID" = "null" ] || [ -z "$NEW_USER_ID" ] || [ "$NEW_USER_ID" = "error" ]; then
            echo "âŒ Could not extract user_id from responses.json"
            echo "ğŸ“‹ Available data:"
            jq '.' responses.json
            exit 1
          fi
          
          echo "user_id=${NEW_USER_ID}" >> $GITHUB_ENV
          echo "âœ… Found new response from user: $NEW_USER_ID"

      - name: Check secrets and test bot token
        run: |
          echo "ğŸ”§ Checking configuration..."
          echo "ğŸ“Š Bot token configured: ${{ secrets.TELEGRAM_BOT_TOKEN != '' }}"
          echo "ğŸ“Š Admin ID configured: ${{ secrets.BOT_ADMIN_ID != '' }}"
          echo "ğŸ“Š Database URL configured: ${{ secrets.DATABASE_URL != '' }}"
          
          # Ğ¢ĞµÑÑ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ñ‚Ğ¾ĞºĞµĞ½ Ğ±Ğ¾Ñ‚Ğ°
          echo "ğŸ§ª Testing bot token..."
          TEST_RESPONSE=$(curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/getMe")
          echo "ğŸ§ª Bot test response: $TEST_RESPONSE"
          
          if echo "$TEST_RESPONSE" | jq -e '.ok == true' > /dev/null; then
            echo "âœ… Bot token is valid!"
            BOT_USERNAME=$(echo "$TEST_RESPONSE" | jq -r '.result.username')
            echo "ğŸ¤– Bot username: @$BOT_USERNAME"
          else
            echo "âŒ Bot token is invalid!"
            exit 1
          fi
        
      - name: Send thank you message to user
        run: |
          echo "ğŸ“¤ Sending thank you message to user ${user_id}..."
          
          # Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Ñ retry
          send_message_with_retry() {
            local chat_id="$1"
            local text="$2"
            local max_retries=3
            local retry_count=0
            
            while [ $retry_count -lt $max_retries ]; do
              echo "ğŸ”„ Attempt $((retry_count + 1)) of $max_retries..."
              
              RESPONSE=$(curl -s -w "%{http_code}" -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
                -H "Content-Type: application/json" \
                -d "{
                  \"chat_id\": \"$chat_id\", 
                  \"text\": \"$text\"
                }")
              
              HTTP_CODE="${RESPONSE: -3}"
              RESPONSE_BODY="${RESPONSE%???}"
              
              echo "ğŸ“¡ HTTP Code: $HTTP_CODE"
              echo "ğŸ“¡ Response: $RESPONSE_BODY"
              
              if [ "$HTTP_CODE" = "200" ] && echo "$RESPONSE_BODY" | jq -e '.ok == true' > /dev/null 2>&1; then
                echo "âœ… Message sent successfully!"
                return 0
              else
                echo "âŒ Failed to send message (attempt $((retry_count + 1)))"
                retry_count=$((retry_count + 1))
                if [ $retry_count -lt $max_retries ]; then
                  echo "â³ Waiting 5 seconds before retry..."
                  sleep 5
                fi
              fi
            done
            
            echo "âŒ All retry attempts failed"
            return 1
          }
          
          # ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
          if send_message_with_retry "${user_id}" "âœ… Ğ‘Ğ»Ğ°Ğ³Ğ¾Ğ´Ğ°Ñ€Ñ Ğ·Ğ° Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ Ğ°Ğ½ĞºĞµÑ‚Ñ‹, Ñ‚Ğ²Ğ¾Ğ¸ Ğ¾Ñ‚Ğ²ĞµÑ‚Ñ‹ Ğ¿Ñ€Ğ¸Ğ½ÑÑ‚Ñ‹! Ğ•ÑĞ»Ğ¸ Ñ‚Ñ‹ Ğ¾ÑÑ‚Ğ°Ğ²Ğ¸Ğ» Ğ·Ğ°ÑĞ²ĞºÑƒ Ğ½Ğ° ĞºĞ¾Ğ½ÑÑƒĞ»ÑŒÑ‚Ğ°Ñ†Ğ¸Ñ, ĞœĞ¸Ñ…Ğ°Ğ¸Ğ» Ñ Ñ‚Ğ¾Ğ±Ğ¾Ğ¹ ÑĞ²ÑĞ¶ĞµÑ‚ÑÑ."; then
            echo "user_notified=true" >> $GITHUB_ENV
          else
            echo "user_notified=false" >> $GITHUB_ENV
          fi

      - name: Send admin info message
        run: |
          echo "ğŸ“¤ Sending admin info message..."
          
          ADMIN_INFO_RESPONSE=$(curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{
              \"chat_id\": \"${{ secrets.BOT_ADMIN_ID }}\", 
              \"text\": \"ğŸ“‹ +1 Ñ‡ĞµĞ»Ğ¾Ğ²ĞµĞº Ğ¿Ñ€Ğ¾ÑˆĞµĞ» Ğ°Ğ½ĞºĞµÑ‚Ñƒ!\\nğŸ‘¤ User ID: ${user_id}\\nâœ… Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ° Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸\"
            }")
          
          echo "ğŸ“¡ Admin info response: $ADMIN_INFO_RESPONSE"
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ÑÑ‚ÑŒ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ñƒ
          if echo "$ADMIN_INFO_RESPONSE" | jq -e '.ok == true' > /dev/null; then
            echo "âœ… Admin info sent successfully!"
            echo "admin_notified=true" >> $GITHUB_ENV
          else
            echo "âŒ Failed to send admin info"
            echo "admin_notified=false" >> $GITHUB_ENV
            echo "ğŸ” Error details: $ADMIN_INFO_RESPONSE"
          fi

      - name: Install PostgreSQL client
        run: |
          echo "ğŸ“¦ Installing PostgreSQL client..."
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Update database directly
        run: |
          echo "ğŸ’¾ Updating database directly..."
          echo "ğŸ”§ User ID: ${user_id}"
          echo "ğŸ”§ Database Host: ${{ secrets.DATABASE_HOST }}"
          echo "ğŸ”§ Database User: ${{ secrets.DATABASE_USER }}"
          echo "ğŸ”§ Database Name: ${{ secrets.DATABASE_NAME }}"
          
          # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ complete_quest Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ Ğ² PostgreSQL
          PGPASSWORD="${{ secrets.DATABASE_PASSWORD }}" psql \
            -h "${{ secrets.DATABASE_HOST }}" \
            -p 6543 \
            -U "${{ secrets.DATABASE_USER }}" \
            -d "${{ secrets.DATABASE_NAME }}" \
            -c "UPDATE users SET complete_quest = 'Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ°' WHERE telegram_id = ${user_id};"
          
          if [ $? -eq 0 ]; then
            echo "âœ… Database updated successfully! Set complete_quest = 'Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ°' for user ${user_id}"
            echo "database_updated=true" >> $GITHUB_ENV
          else
            echo "âŒ Failed to update database"
            echo "database_updated=false" >> $GITHUB_ENV
          fi

      - name: Verify database update
        run: |
          echo "ğŸ” Verifying database update..."
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‡Ñ‚Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ¾ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾
          RESULT=$(PGPASSWORD="${{ secrets.DATABASE_PASSWORD }}" psql \
            -h "${{ secrets.DATABASE_HOST }}" \
            -p 6543 \
            -U "${{ secrets.DATABASE_USER }}" \
            -d "${{ secrets.DATABASE_NAME }}" \
            -t -c "SELECT complete_quest FROM users WHERE telegram_id = ${user_id};")
          
          echo "ğŸ“‹ Current complete_quest status for user ${user_id}: $RESULT"
          
          if [[ "$RESULT" == *"Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ°"* ]]; then
            echo "âœ… Database verification successful!"
          else
            echo "âš ï¸ Database verification failed or status not as expected"
          fi
          
      - name: Final status report
        run: |
          echo "ğŸ¯ Final Status Report:"
          echo "ğŸ‘¤ User ID: ${user_id}"
          echo "ğŸ“¤ User notified: ${user_notified:-false}"
          echo "ğŸ‘¨â€ğŸ’¼ Admin notified: ${admin_notified:-false}"
          echo "ğŸ’¾ Database updated: ${database_updated:-false}"
          
          if [ "${user_notified:-false}" = "true" ] && [ "${admin_notified:-false}" = "true" ] && [ "${database_updated:-false}" = "true" ]; then
            echo "ğŸ‰ All operations completed successfully!"
          else
            echo "âš ï¸ Some operations failed"
            exit 1
          fi 
