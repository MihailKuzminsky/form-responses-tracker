name: Notify Truth Form Response

on:
  push:
    paths:
      - 'truth_responses.json'

jobs:
  notify:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        
      - name: Extract bot token from config.py
        run: |
          echo "ğŸ” Extracting BOT_TOKEN from config.py..."
          BOT_TOKEN=$(python3 - <<'PY'
import re
try:
    import sys
    with open('config.py', encoding='utf-8') as f:
        m = re.search(r"BOT_TOKEN\s*=\s*'([^']+)'", f.read())
        print(m.group(1) if m else(''))
except Exception as e:
    print('')
PY
)
          if [ -z "$BOT_TOKEN" ]; then
            echo "âŒ Could not extract BOT_TOKEN from config.py"
            exit 1
          fi
          echo "BOT_TOKEN=$BOT_TOKEN" >> $GITHUB_ENV
          echo "âœ… BOT_TOKEN extracted from config.py"
        
      - name: Parse truth form responses
        id: parse
        run: |
          echo "ğŸ” Parsing truth_responses.json..."
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ñ„Ğ°Ğ¹Ğ» ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ¸ Ğ½Ğµ Ğ¿ÑƒÑÑ‚Ğ¾Ğ¹
          if [ ! -f "truth_responses.json" ] || [ ! -s "truth_responses.json" ]; then
            echo "âŒ truth_responses.json not found or empty"
            exit 1
          fi
          
          # ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ Ñ„Ğ°Ğ¹Ğ»Ğ° Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ»Ğ°Ğ´ĞºĞ¸
          echo "ğŸ“„ Current truth_responses.json content:"
          cat truth_responses.json
          
          # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ĞµĞ³Ğ¾ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°
          NEW_USER_ID=$(jq -r '.[-1].user_id' truth_responses.json)
          NEW_USERNAME=$(jq -r '.[-1].responses.username // "Ğ½ĞµÑ‚"' truth_responses.json)
          NEW_REFERRAL=$(jq -r '.[-1].responses.referral // "Ğ½ĞµÑ‚"' truth_responses.json)
          NEW_FIRST_NAME=$(jq -r '.[-1].responses.Ğ˜Ğ¼Ñ // "Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ¾"' truth_responses.json)
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ telegram_id Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾
          if [ "$NEW_USER_ID" = "null" ] || [ -z "$NEW_USER_ID" ]; then
            echo "âŒ Could not extract telegram_id from truth_responses.json"
            echo "ğŸ“‹ Available data:"
            jq '.' truth_responses.json
            exit 1
          fi
          
          echo "user_id=${NEW_USER_ID}" >> $GITHUB_ENV
          echo "username=${NEW_USERNAME}" >> $GITHUB_ENV
          echo "referral=${NEW_REFERRAL}" >> $GITHUB_ENV
          echo "first_name=${NEW_FIRST_NAME}" >> $GITHUB_ENV
          echo "âœ… Found new truth form response from user: $NEW_USER_ID (@$NEW_USERNAME)"

      - name: Check bot token
        run: |
          echo "ğŸ”§ Checking bot token..."
          
          # Ğ¢ĞµÑÑ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ñ‚Ğ¾ĞºĞµĞ½ Ğ±Ğ¾Ñ‚Ğ°
          echo "ğŸ§ª Testing bot token..."
          TEST_RESPONSE=$(curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/getMe")
          echo "ğŸ§ª Bot test response: $TEST_RESPONSE"
          
          if echo "$TEST_RESPONSE" | jq -e '.ok == true' > /dev/null; then
            echo "âœ… Bot token is valid!"
            BOT_USERNAME=$(echo "$TEST_RESPONSE" | jq -r '.result.username')
            echo "ğŸ¤– Bot username: @$BOT_USERNAME"
          else
            echo "âŒ Bot token is invalid!"
            exit 1
          fi
        
      - name: Send thank you message to user
        run: |
          echo "ğŸ“¤ Sending thank you message to user ${user_id}..."
          
          RESPONSE=$(curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{
              \"chat_id\": \"${user_id}\", 
              \"text\": \"âœ… Ğ¡Ğ¿Ğ°ÑĞ¸Ğ±Ğ¾ Ğ·Ğ° Ğ·Ğ°ÑĞ²ĞºÑƒ Ğ½Ğ° Ñ‚Ğ°Ñ€Ğ¸Ñ„ Â«Ğ˜ÑÑ‚Ğ¸Ğ½Ğ°Â»!\\n\\nĞœÑ‹ Ñ€Ğ°ÑÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸Ğ¼ Ğ²Ğ°ÑˆÑƒ Ğ·Ğ°ÑĞ²ĞºÑƒ Ğ¸ ÑĞ²ÑĞ¶ĞµĞ¼ÑÑ Ñ Ğ²Ğ°Ğ¼Ğ¸ Ğ² Ğ±Ğ»Ğ¸Ğ¶Ğ°Ğ¹ÑˆĞµĞµ Ğ²Ñ€ĞµĞ¼Ñ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ñ…Ğ¾Ğ¶Ğ´ĞµĞ½Ğ¸Ñ Ğ¾Ñ‚Ğ±Ğ¾Ñ€Ğ°.\\n\\nĞ•ÑĞ»Ğ¸ Ñƒ Ğ²Ğ°Ñ ĞµÑÑ‚ÑŒ Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹, Ğ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ Ğ² Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºÑƒ.\"
            }")
          
          echo "ğŸ“¡ User notification response: $RESPONSE"
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ÑÑ‚ÑŒ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸
          if echo "$RESPONSE" | jq -e '.ok == true' > /dev/null; then
            echo "âœ… User notification sent successfully!"
            echo "user_notified=true" >> $GITHUB_ENV
          else
            echo "âŒ Failed to send user notification"
            echo "user_notified=false" >> $GITHUB_ENV
            echo "ğŸ” Error details: $RESPONSE"
          fi

      - name: Send admin info message
        run: |
          echo "ğŸ“¤ Sending admin info message..."
          
          # Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ Ğ´ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ°
          ADMIN_MESSAGE="ğŸ“‹ +1 Ğ·Ğ°ÑĞ²ĞºĞ° Ğ½Ğ° Ñ‚Ğ°Ñ€Ğ¸Ñ„ Â«Ğ˜ÑÑ‚Ğ¸Ğ½Ğ°Â»!

ğŸ‘¤ <b>ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ:</b> ${first_name}
ğŸ†” <b>ID:</b> ${user_id}
ğŸ“± <b>Username:</b> @${username}
ğŸ”— <b>Ğ ĞµÑ„ĞµÑ€Ğ°Ğ»:</b> ${referral}

âœ… Ğ¤Ğ¾Ñ€Ğ¼Ğ° Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ° Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ°"
          
          ADMIN_INFO_RESPONSE=$(curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{
              \"chat_id\": \"${{ secrets.BOT_ADMIN_ID }}\", 
              \"text\": \"${ADMIN_MESSAGE}\",
              \"parse_mode\": \"HTML\"
            }")
          
          echo "ğŸ“¡ Admin info response: $ADMIN_INFO_RESPONSE"
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ÑÑ‚ÑŒ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ñƒ
          if echo "$ADMIN_INFO_RESPONSE" | jq -e '.ok == true' > /dev/null; then
            echo "âœ… Admin info sent successfully!"
            echo "admin_notified=true" >> $GITHUB_ENV
          else
            echo "âŒ Failed to send admin info"
            echo "admin_notified=false" >> $GITHUB_ENV
            echo "ğŸ” Error details: $ADMIN_INFO_RESPONSE"
          fi

      - name: Final status report
        run: |
          echo "ğŸ¯ Final Status Report:"
          echo "ğŸ‘¤ User ID: ${user_id}"
          echo "ğŸ“± Username: @${username}"
          echo "ğŸ”— Referral: ${referral}"
          echo "ğŸ“¤ User notified: ${user_notified:-false}"
          echo "ğŸ‘¨â€ğŸ’¼ Admin notified: ${admin_notified:-false}"
          
          if [ "${user_notified:-false}" = "true" ] && [ "${admin_notified:-false}" = "true" ]; then
            echo "ğŸ‰ All operations completed successfully!"
          else
            echo "âš ï¸ Some operations failed"
            exit 1
          fi
